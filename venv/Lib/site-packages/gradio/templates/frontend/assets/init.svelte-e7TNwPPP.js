import*as h from"./svelte/svelte_internal_client.js";import{f as w,h as d,t as u,j as g}from"./i18n-jwgpNIDD.js";import{tick as f}from"./svelte/svelte_svelte.js";import{a as m}from"./utils.svelte-Ceck75cM.js";import"./index-CGvp2os9.js";const k={walkthrough:"tabs",walkthroughstep:"tabitem"};class z{#s;#e;#r;reactive_formatter=t=>t;#t;client;#i=h.state();get root(){return h.get(this.#i)}set root(t){h.set(this.#i,t,!0)}#n=new Set;#o=new Set;#l=[];#p=new Map;#a=new Map;component_ids;initial_tabs={};components_to_register=new Set;ready;ready_resolve;resolved=!1;constructor(t,r,i,n,s,o){this.ready=new Promise(p=>{this.ready_resolve=p}),this.reactive_formatter=o,this.#t={...n,api_url:new URL(n.api_prefix,n.root).toString()},this.#s=t,this.#e=r,this.#r=i,this.root=this.create_node({id:r.id,children:[]},new Map,!0);for(const p of t)p.props.visible!=!1&&this.components_to_register.add(p.id);this.client=s,this.prepare();const a=t.reduce((p,l)=>(p.set(l.id,l),p),new Map);this.root.children=this.#e.children.map(p=>this.traverse(p,l=>this.create_node(l,a,!1,this.reactive_formatter))),this.component_ids=t.map(p=>p.id),this.initial_tabs={},v(this.root,this.initial_tabs),this.postprocess(this.root)}reload(t,r,i,n){this.#e=r,this.#s=t,this.#t={...n,api_url:new URL(n.api_prefix,n.root).toString()},this.#r=i,this.root=this.create_node({id:r.id,children:[]},new Map,!0);for(const o of t)o.props.visible!=!1&&this.components_to_register.add(o.id);this.prepare();const s=t.reduce((o,a)=>(o.set(a.id,a),o),new Map);this.root.children=this.#e.children.map(o=>this.traverse(o,a=>this.create_node(a,s,!1,this.reactive_formatter))),this.component_ids=t.map(o=>o.id),this.initial_tabs={},v(this.root,this.initial_tabs),this.postprocess(this.root)}register_component(t,r,i){this.#a.set(t,r),this.#p.set(t,i),this.components_to_register.delete(t),this.components_to_register.size===0&&!this.resolved&&(this.resolved=!0,this.ready_resolve())}prepare(){const[t,r]=w(this.#r);this.#n=t,this.#o=r}process(){}postprocess(t){this.root=this.traverse(t,[r=>c(r,this.#t.api_url),r=>A(r,this.components_to_register),r=>j(r,this.components_to_register),r=>x(r),r=>R(r,this.initial_tabs),r=>this.find_attached_events(r,this.#r)])}find_attached_events(t,r){const i=r.filter(n=>n.targets.find(([s])=>s===t.id)).map(n=>{const s=n.targets.find(([o])=>o===t.id);return s?s[1]:null}).filter(Boolean);return t.props.shared_props.attached_events=i,t}traverse(t,r){function i(n,s,o){const a=s(n);return"children"in n&&n.children.length>0&&(a.children=n.children?.map(p=>o(p,s))||[]),a}if(Array.isArray(r)){let n=t;for(const s of r)n=i(n,s,this.traverse.bind(this));return n}else return i(t,r,this.traverse.bind(this))}create_node(t,r,i=!1,n){let s;if(i?s={type:"column",id:t.id,props:{visible:!0,root:"",theme_mode:"light"},component_class_id:"column",key:null}:s=r.get(t.id),!s)throw new Error(`Component with ID ${t.id} not found`);n&&(s.props.i18n=n);const o=E(t.id,s.props,[this.#n,this.#o],this.client,this.#t.api_url,{...this.#t}),a=k[s.type]||s.type;return{id:t.id,type:a,props:o,children:[],show_progress_on:null,component_class_id:s.component_class_id||s.type,component:o.shared_props.visible!==!1?d(s.type,s.component_class_id,this.#t.api_url||""):null,key:s.key,rendered_in:s.rendered_in,documentation:s.documentation}}rerender(t,r){const i=t.reduce((o,a)=>(o.set(a.id,a),o),new Map),n=this.traverse(r,o=>this.create_node(o,i,!1,this.reactive_formatter)),s=_(this.root,n.id);if(!s)throw new Error("Rerender failed: root node not found in current tree");s.children=n.children}async update_state(t,r,i=!0){const n=_(this.root,t);let s=!1;i&&!n?.component&&(await f(),this.root=this.traverse(this.root,[a=>S(a,t,r.visible),a=>c(a,this.#t.api_url)]),s=!0);const o=this.#a.get(t);o&&(o(r),!(!i||s)&&(await f(),this.root=this.traverse(this.root,a=>c(a,this.#t.api_url))))}async get_state(t){const r=this.#p.get(t),i=this.#s.find(n=>n.id===t);return!r&&!i?null:r?await r():i?Promise.resolve({value:i.props.value}):null}}function M(e,t,r){return t?t.reduce((i,n)=>(i[n]=async(...s)=>(s.length===1&&(s=s[0]),await r.component_server(e,n,s)),i),{}):{}}function E(e,t,r,i,n,s={}){const o={},a={};for(const p in t)if(p==="id"||p==="autoscroll")a[p]=t[p];else if(m.includes(p)){const l=p;o[l]=t[p],l==="server_fns"&&(o.server=M(e,t.server_fns,i))}else a[p]=t[p];for(const p in s)if(m.includes(p)){const l=p;o[l]=s[p]}else a[p]=s[p];return o.client=i,o.id=e,o.interactive=g(e,o.interactive,a.value,r),o.load_component=(p,l)=>d(p,"",n,l),o.visible=o.visible===void 0?!0:o.visible,o.loading_status={},{shared_props:o,props:a}}function c(e,t){if(e.props.shared_props.visible&&!e.component){const r={...e,component:d(e.type,e.component_class_id,t),children:[]};return e.children&&(r.children=e.children.map(i=>c(i,t))),r}else return e}function S(e,t,r){return e.id==t&&(e.props.shared_props.visible=r),e}function y(e,t){t.delete(e.id),e.children&&e.children.forEach(r=>y(r,t))}function A(e,t){return e.props.shared_props.visible!==!0&&y(e,t),e}function j(e,t){return e.type==="form"&&e.children.every(i=>i.props.shared_props.visible===!1)&&(e.props.shared_props.visible=!1,t.delete(e.id)),e}function x(e){const t=["description","info","title","placeholder","value","label"];for(const r of Object.keys(e.props.shared_props))t.includes(r)&&(e.props.shared_props[r]=u(e.props.shared_props[r]));for(const r of Object.keys(e.props.props))t.includes(r)&&(e.props.props[r]=u(e.props.props[r]));return e}function R(e,t){if(e.type==="tabs"&&e.id in t){const r=t[e.id].sort((i,n)=>i.order-n.order);e.props.props.initial_tabs=r}return e}function b(e,t,r,i){r!==null&&e.type==="tabitem"&&(r in t||(t[r]=[]),"id"in e.props.props||(e.props.props.id=e.id),t[r].push({label:e.props.shared_props.label,id:e.props.props.id,elem_id:e.props.shared_props.elem_id,visible:e.props.shared_props.visible,interactive:e.props.shared_props.interactive,scale:e.props.shared_props.scale||null}),e.props.props.order=i),e.children&&e.children.forEach((n,s)=>{b(n,t,e.type==="tabs"?e.id:null,e.type==="tabs"?s:null)})}function v(e,t){function r(i){"children"in i&&i.children.length>0&&i.children?.forEach(n=>b(n,t,i.type==="tabs"?i.id:null,null))}return r(e)}function _(e,t){if(e.id===t)return e;if(e.children)for(const r of e.children){const i=_(r,t);if(i)return i}return null}export{z as A};
